<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

function scanFile($file, $fileName)
{
    $malwareSignatures = [
        'eval(',
        'base64_decode(',
        'shell_exec(',
        'system(',
    ];

    if (!file_exists($file)) {
        return ["message" => "Error: File not found.", "fileName" => $fileName];
    }

    $content = file_get_contents($file);

    if ($content === false) {
        return ["message" => "Error: Unable to read file.", "fileName" => $fileName];
    }

    foreach ($malwareSignatures as $signature) {
        if (strpos($content, $signature) !== false) {
            return ["message" => "Malware detected!", "fileName" => $fileName];
        }
    }

    // Move the file to a safe directory if it's clean
    $safeDir = 'safe_files/';
    if (!is_dir($safeDir)) {
        mkdir($safeDir, 0755, true);
    }
    $newFilePath = $safeDir . basename($fileName);
    move_uploaded_file($file, $newFilePath);

    return ["message" => "File is clean.", "fileName" => $fileName];
}

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (isset($_FILES['file']) && $_FILES['file']['error'] == UPLOAD_ERR_OK) {
        $file = $_FILES['file']['tmp_name'];
        $fileName = $_FILES['file']['name'];
        $result = scanFile($file, $fileName);
    } else {
        $result = ["message" => "Please upload a file.", "fileName" => ""];
    }

    echo json_encode($result);
    exit;
}
?>